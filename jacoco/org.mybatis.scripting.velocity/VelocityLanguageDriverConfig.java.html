<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VelocityLanguageDriverConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MyBatis Velocity</a> &gt; <a href="index.source.html" class="el_package">org.mybatis.scripting.velocity</a> &gt; <span class="el_source">VelocityLanguageDriverConfig.java</span></div><h1>VelocityLanguageDriverConfig.java</h1><pre class="source lang-java linenums">/*
 *    Copyright 2012-2022 the original author or authors.
 *
 *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       https://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package org.mybatis.scripting.velocity;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.nio.charset.Charset;
import java.nio.charset.StandardCharsets;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.Properties;
import java.util.Set;
import java.util.StringJoiner;
import java.util.function.Consumer;
import java.util.function.Function;
import java.util.stream.Stream;

import org.apache.commons.text.WordUtils;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.logging.Log;
import org.apache.ibatis.logging.LogFactory;
import org.apache.ibatis.reflection.DefaultReflectorFactory;
import org.apache.ibatis.reflection.MetaObject;
import org.apache.ibatis.reflection.factory.DefaultObjectFactory;
import org.apache.ibatis.reflection.property.PropertyTokenizer;
import org.apache.ibatis.reflection.wrapper.DefaultObjectWrapperFactory;
import org.apache.ibatis.scripting.ScriptingException;
import org.apache.velocity.runtime.RuntimeConstants;
import org.apache.velocity.runtime.RuntimeInstance;
import org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader;

/**
 * Configuration class for {@link Driver}.
 *
 * @author Kazuki Shimizu
 *
 * @since 2.1.0
 */
<span class="fc" id="L58">public class VelocityLanguageDriverConfig {</span>

  private static final String PROPERTY_KEY_CONFIG_FILE = &quot;mybatis-velocity.config.file&quot;;
  private static final String PROPERTY_KEY_CONFIG_ENCODING = &quot;mybatis-velocity.config.encoding&quot;;
  private static final String DEFAULT_PROPERTIES_FILE = &quot;mybatis-velocity.properties&quot;;
  private static final String PROPERTY_KEY_ADDITIONAL_CONTEXT_ATTRIBUTE = &quot;additional.context.attributes&quot;;
<span class="fc" id="L64">  private static final String[] BUILT_IN_DIRECTIVES = { TrimDirective.class.getName(), WhereDirective.class.getName(),</span>
<span class="fc" id="L65">      SetDirective.class.getName(), InDirective.class.getName(), RepeatDirective.class.getName() };</span>

  private static final Map&lt;Class&lt;?&gt;, Function&lt;String, Object&gt;&gt; TYPE_CONVERTERS;
  static {
<span class="fc" id="L69">    Map&lt;Class&lt;?&gt;, Function&lt;String, Object&gt;&gt; converters = new HashMap&lt;&gt;();</span>
<span class="fc" id="L70">    converters.put(String.class, String::trim);</span>
<span class="pc" id="L71">    converters.put(Charset.class, v -&gt; Charset.forName(v.trim()));</span>
<span class="fc" id="L72">    converters.put(String[].class, v -&gt; Stream.of(v.split(&quot;,&quot;)).map(String::trim).toArray(String[]::new));</span>
<span class="pc" id="L73">    converters.put(Object.class, v -&gt; v);</span>
<span class="fc" id="L74">    TYPE_CONVERTERS = Collections.unmodifiableMap(converters);</span>
  }

<span class="fc" id="L77">  private static final Log log = LogFactory.getLog(VelocityLanguageDriverConfig.class);</span>

  /**
   * The Velocity settings.
   */
<span class="fc" id="L82">  private final Map&lt;String, String&gt; velocitySettings = new HashMap&lt;&gt;();</span>
  {
<span class="fc" id="L84">    velocitySettings.put(RuntimeConstants.RESOURCE_LOADERS, &quot;class&quot;);</span>
<span class="fc" id="L85">    velocitySettings.put(RuntimeConstants.RESOURCE_LOADER + &quot;.class.class&quot;, ClasspathResourceLoader.class.getName());</span>
  }

  /**
   * The base directory for reading template resources.
   */
<span class="fc" id="L91">  private String[] userDirectives = {};</span>

  /**
   * The additional context attribute.
   */
<span class="fc" id="L96">  private final Map&lt;String, String&gt; additionalContextAttributes = new HashMap&lt;&gt;();</span>

  /**
   * Get Velocity settings.
   *
   * @return Velocity settings
   */
  public Map&lt;String, String&gt; getVelocitySettings() {
<span class="fc" id="L104">    return velocitySettings;</span>
  }

  /**
   * Get user define directives.
   *
   * @return user define directives.
   *
   * @deprecated Recommend to use the 'velocity-settings.runtime.custom_directives' or 'runtime.custom_directives'
   *             because this method defined for keeping backward compatibility (There is possibility that this method
   *             removed at a future version)
   */
  @Deprecated
  public String[] getUserdirective() {
<span class="fc" id="L118">    return userDirectives;</span>
  }

  /**
   * Set user define directives.
   *
   * @param userDirectives
   *          user define directives
   *
   * @deprecated Recommend to use the 'velocity-settings.runtime.custom_directives' or 'runtime.custom_directives'
   *             because this method defined for keeping backward compatibility (There is possibility that this method
   *             removed at a future version)
   */
  @Deprecated
  public void setUserdirective(String... userDirectives) {
<span class="fc" id="L133">    log.warn(</span>
        &quot;The 'userdirective' has been deprecated since 2.1.0. Please use the 'velocity-settings.runtime.custom_directives' or 'runtime.custom_directives'.&quot;);
<span class="fc" id="L135">    this.userDirectives = userDirectives;</span>
<span class="fc" id="L136">  }</span>

  /**
   * Get additional context attributes.
   *
   * @return additional context attributes
   */
  public Map&lt;String, String&gt; getAdditionalContextAttributes() {
<span class="fc" id="L144">    return additionalContextAttributes;</span>
  }

  /**
   * Generate a custom directives string.
   *
   * @return a custom directives string
   */
  public String generateCustomDirectivesString() {
<span class="fc" id="L153">    StringJoiner customDirectivesJoiner = new StringJoiner(&quot;,&quot;);</span>
<span class="fc" id="L154">    Optional.ofNullable(velocitySettings.get(RuntimeConstants.CUSTOM_DIRECTIVES))</span>
<span class="fc" id="L155">        .ifPresent(customDirectivesJoiner::add);</span>
<span class="fc" id="L156">    Stream.of(userDirectives).forEach(customDirectivesJoiner::add);</span>
<span class="fc" id="L157">    Stream.of(BUILT_IN_DIRECTIVES).forEach(customDirectivesJoiner::add);</span>
<span class="fc" id="L158">    return customDirectivesJoiner.toString();</span>
  }

  /**
   * Create an instance from default properties file. &lt;br&gt;
   * If you want to customize a default {@link RuntimeInstance}, you can configure some property using
   * mybatis-velocity.properties that encoded by UTF-8. Also, you can change the properties file that will read using
   * system property (-Dmybatis-velocity.config.file=... -Dmybatis-velocity.config.encoding=...). &lt;br&gt;
   * Supported properties are as follows:
   * &lt;table border=&quot;1&quot;&gt;
   * &lt;caption&gt;Supported properties&lt;/caption&gt;
   * &lt;tr&gt;
   * &lt;th&gt;Property Key&lt;/th&gt;
   * &lt;th&gt;Description&lt;/th&gt;
   * &lt;th&gt;Default&lt;/th&gt;
   * &lt;/tr&gt;
   * &lt;tr&gt;
   * &lt;th colspan=&quot;3&quot;&gt;Directive configuration&lt;/th&gt;
   * &lt;/tr&gt;
   * &lt;tr&gt;
   * &lt;td&gt;userdirective&lt;/td&gt;
   * &lt;td&gt;The user defined directives (Recommend to use the 'velocity-settings.runtime.custom_directives' property
   * because this property defined for keeping backward compatibility)&lt;/td&gt;
   * &lt;td&gt;None(empty)&lt;/td&gt;
   * &lt;/tr&gt;
   * &lt;tr&gt;
   * &lt;th colspan=&quot;3&quot;&gt;Additional context attribute configuration&lt;/th&gt;
   * &lt;/tr&gt;
   * &lt;tr&gt;
   * &lt;td&gt;additional.context.attributes&lt;/td&gt;
   * &lt;td&gt;The user defined additional context attribute values(Recommend to use the
   * 'additional-context-attributes.{name}' because this property defined for keeping backward compatibility)&lt;/td&gt;
   * &lt;td&gt;None(empty)&lt;/td&gt;
   * &lt;/tr&gt;
   * &lt;tr&gt;
   * &lt;td&gt;additional-context-attributes.{name}&lt;/td&gt;
   * &lt;td&gt;The user defined additional context attributes value(FQCN)&lt;/td&gt;
   * &lt;td&gt;-&lt;/td&gt;
   * &lt;/tr&gt;
   * &lt;tr&gt;
   * &lt;th colspan=&quot;3&quot;&gt;Velocity settings configuration&lt;/th&gt;
   * &lt;/tr&gt;
   * &lt;tr&gt;
   * &lt;td&gt;velocity-settings.{name}&lt;/td&gt;
   * &lt;td&gt;The settings of Velocity's {@link RuntimeInstance#setProperty(String, Object)}&lt;/td&gt;
   * &lt;td&gt;-&lt;/td&gt;
   * &lt;/tr&gt;
   * &lt;tr&gt;
   * &lt;td&gt;{name}&lt;/td&gt;
   * &lt;td&gt;The settings of Velocity's {@link RuntimeInstance#setProperty(String, Object)} (Recommend to use the
   * 'velocity-settings.{name}' because this property defined for keeping backward compatibility)&lt;/td&gt;
   * &lt;td&gt;-&lt;/td&gt;
   * &lt;/tr&gt;
   * &lt;/table&gt;
   *
   * @return a configuration instance
   */
  public static VelocityLanguageDriverConfig newInstance() {
<span class="fc" id="L216">    return newInstance(loadDefaultProperties());</span>
  }

  /**
   * Create an instance from specified properties.
   *
   * @param customProperties
   *          custom configuration properties
   *
   * @return a configuration instance
   *
   * @see #newInstance()
   */
  public static VelocityLanguageDriverConfig newInstance(Properties customProperties) {
<span class="fc" id="L230">    VelocityLanguageDriverConfig config = new VelocityLanguageDriverConfig();</span>
<span class="fc" id="L231">    Properties properties = loadDefaultProperties();</span>
<span class="fc" id="L232">    Optional.ofNullable(customProperties).ifPresent(properties::putAll);</span>
<span class="fc" id="L233">    override(config, properties);</span>
<span class="fc" id="L234">    configureVelocitySettings(config, properties);</span>
<span class="fc" id="L235">    return config;</span>
  }

  /**
   * Create an instance using specified customizer and override using a default properties file.
   *
   * @param customizer
   *          baseline customizer
   *
   * @return a configuration instance
   *
   * @see #newInstance()
   */
  public static VelocityLanguageDriverConfig newInstance(Consumer&lt;VelocityLanguageDriverConfig&gt; customizer) {
<span class="fc" id="L249">    VelocityLanguageDriverConfig config = new VelocityLanguageDriverConfig();</span>
<span class="fc" id="L250">    Properties properties = loadDefaultProperties();</span>
<span class="fc" id="L251">    customizer.accept(config);</span>
<span class="fc" id="L252">    override(config, properties);</span>
<span class="fc" id="L253">    configureVelocitySettings(config, properties);</span>
<span class="fc" id="L254">    return config;</span>
  }

  private static void override(VelocityLanguageDriverConfig config, Properties properties) {
<span class="fc" id="L258">    enableLegacyAdditionalContextAttributes(properties);</span>
<span class="fc" id="L259">    MetaObject metaObject = MetaObject.forObject(config, new DefaultObjectFactory(), new DefaultObjectWrapperFactory(),</span>
        new DefaultReflectorFactory());
<span class="fc" id="L261">    Set&lt;Object&gt; consumedKeys = new HashSet&lt;&gt;();</span>
<span class="fc" id="L262">    properties.forEach((key, value) -&gt; {</span>
<span class="fc" id="L263">      String propertyPath = WordUtils</span>
<span class="fc" id="L264">          .uncapitalize(WordUtils.capitalize(Objects.toString(key), '-').replaceAll(&quot;-&quot;, &quot;&quot;));</span>
<span class="fc bfc" id="L265" title="All 2 branches covered.">      if (metaObject.hasSetter(propertyPath)) {</span>
<span class="fc" id="L266">        PropertyTokenizer pt = new PropertyTokenizer(propertyPath);</span>
<span class="fc bfc" id="L267" title="All 2 branches covered.">        if (Map.class.isAssignableFrom(metaObject.getGetterType(pt.getName()))) {</span>
          @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L269">          Map&lt;String, Object&gt; map = (Map&lt;String, Object&gt;) metaObject.getValue(pt.getName());</span>
<span class="fc" id="L270">          map.put(pt.getChildren(), value);</span>
<span class="fc" id="L271">        } else {</span>
<span class="fc" id="L272">          Optional.ofNullable(value).ifPresent(v -&gt; {</span>
<span class="fc" id="L273">            Object convertedValue = TYPE_CONVERTERS.get(metaObject.getSetterType(propertyPath)).apply(value.toString());</span>
<span class="fc" id="L274">            metaObject.setValue(propertyPath, convertedValue);</span>
<span class="fc" id="L275">          });</span>
        }
<span class="fc" id="L277">        consumedKeys.add(key);</span>
      }
<span class="fc" id="L279">    });</span>
<span class="fc" id="L280">    consumedKeys.forEach(properties::remove);</span>
<span class="fc" id="L281">  }</span>

  private static void enableLegacyAdditionalContextAttributes(Properties properties) {
<span class="fc" id="L284">    String additionalContextAttributes = properties.getProperty(PROPERTY_KEY_ADDITIONAL_CONTEXT_ATTRIBUTE);</span>
<span class="fc bfc" id="L285" title="All 2 branches covered.">    if (Objects.nonNull(additionalContextAttributes)) {</span>
<span class="fc" id="L286">      log.warn(String.format(</span>
          &quot;The '%s' has been deprecated since 2.1.0. Please use the 'additionalContextAttributes.{name}={value}'.&quot;,
          PROPERTY_KEY_ADDITIONAL_CONTEXT_ATTRIBUTE));
<span class="fc" id="L289">      Stream.of(additionalContextAttributes.split(&quot;,&quot;)).forEach(pair -&gt; {</span>
<span class="fc" id="L290">        String[] keyValue = pair.split(&quot;:&quot;);</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">        if (keyValue.length != 2) {</span>
<span class="fc" id="L292">          throw new ScriptingException(&quot;Invalid additional context property '&quot; + pair + &quot;' on '&quot;</span>
              + PROPERTY_KEY_ADDITIONAL_CONTEXT_ATTRIBUTE + &quot;'. Must be specify by 'key:value' format.&quot;);
        }
<span class="fc" id="L295">        properties.setProperty(&quot;additional-context-attributes.&quot; + keyValue[0].trim(), keyValue[1].trim());</span>
<span class="fc" id="L296">      });</span>
<span class="fc" id="L297">      properties.remove(PROPERTY_KEY_ADDITIONAL_CONTEXT_ATTRIBUTE);</span>
    }
<span class="fc" id="L299">  }</span>

  private static void configureVelocitySettings(VelocityLanguageDriverConfig config, Properties properties) {
<span class="fc" id="L302">    properties.forEach((name, value) -&gt; config.getVelocitySettings().put((String) name, (String) value));</span>
<span class="fc" id="L303">  }</span>

  private static Properties loadDefaultProperties() {
<span class="fc" id="L306">    return loadProperties(System.getProperty(PROPERTY_KEY_CONFIG_FILE, DEFAULT_PROPERTIES_FILE));</span>
  }

  private static Properties loadProperties(String resourcePath) {
<span class="fc" id="L310">    Properties properties = new Properties();</span>
    InputStream in;
    try {
<span class="fc" id="L313">      in = Resources.getResourceAsStream(resourcePath);</span>
<span class="fc" id="L314">    } catch (IOException e) {</span>
<span class="fc" id="L315">      in = null;</span>
<span class="fc" id="L316">    }</span>
<span class="fc bfc" id="L317" title="All 2 branches covered.">    if (in != null) {</span>
<span class="fc" id="L318">      Charset encoding = Optional.ofNullable(System.getProperty(PROPERTY_KEY_CONFIG_ENCODING)).map(Charset::forName)</span>
<span class="fc" id="L319">          .orElse(StandardCharsets.UTF_8);</span>
<span class="fc" id="L320">      try (InputStreamReader inReader = new InputStreamReader(in, encoding);</span>
<span class="fc" id="L321">          BufferedReader bufReader = new BufferedReader(inReader)) {</span>
<span class="fc" id="L322">        properties.load(bufReader);</span>
<span class="nc" id="L323">      } catch (IOException e) {</span>
<span class="nc" id="L324">        throw new IllegalStateException(e);</span>
<span class="fc" id="L325">      }</span>
    }
<span class="fc" id="L327">    return properties;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>